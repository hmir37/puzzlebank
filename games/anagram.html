<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anagram — Puzzlebank</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* ── Anagram-specific ──────────────────────────────────────── */
    .letter-tiles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: 2rem 0 1rem;
      min-height: 64px;
    }

    .tile {
      width: 52px;
      height: 56px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.6rem;
      font-weight: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      text-transform: uppercase;
    }

    .tile:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .tile.used  { opacity: 0.2; cursor: default; transform: none; box-shadow: none; }
    .tile.shake { animation: shakeTile 0.3s ease; }

    @keyframes shakeTile {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-5px) rotate(-3deg); }
      75% { transform: translateX(5px) rotate(3deg); }
    }

    /* Answer boxes */
    .answer-tiles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: 0 0 1.5rem;
      min-height: 64px;
    }

    .answer-slot {
      width: 52px;
      height: 56px;
      border: 1px solid var(--accent);
      border-radius: var(--radius-md);
      background: var(--bg);
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.6rem;
      font-weight: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.15s ease;
      color: var(--accent);
    }

    .answer-slot:empty { border-style: dashed; }
    .answer-slot:not(:empty):hover { background: var(--surface-alt); }

    .answer-slot.correct-anim { border-color: var(--correct); color: var(--correct); background: rgba(107,127,117,0.08); }
    .answer-slot.wrong-anim   { border-color: var(--wrong);   color: var(--wrong);   background: rgba(181,107,94,0.08); }

    /* Category pill */
    .category-label {
      text-align: center;
      margin-bottom: 0.5rem;
    }

    /* Controls */
    .controls-row {
      display: flex;
      gap: 0.6rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    /* Start screen */
    .start-screen {
      text-align: center;
      padding: 2.5rem 1.5rem;
    }
    .start-screen h2 { margin-bottom: 0.75rem; }
    .start-screen p {
      color: var(--text-muted);
      font-size: 0.9rem;
      max-width: 340px;
      margin: 0 auto 2rem;
      line-height: 1.7;
    }

    /* Timer row */
    .timer-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .timer-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 300;
      min-width: 2.5ch;
      text-align: center;
    }
    .timer-value.urgent { color: var(--wrong); }
  </style>
</head>
<body>

  <nav class="site-nav">
    <a href="../index.html" class="logo">Puzzlebank</a>
    <a href="../index.html" class="nav-link">← All games</a>
  </nav>

  <main class="game-wrap">

    <div class="game-header">
      <div>
        <h1 class="game-title">Anagram</h1>
        <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.3rem">Unscramble the word</p>
      </div>
      <div class="game-meta">
        <span class="stat-label">Score</span>
        <span class="stat-value" id="score-display">0</span>
        <div class="level-badge mt-1">
          <span class="stat-label">Level</span>
          <span id="level-display" style="font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:300">1</span>
        </div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>

    <!-- Start screen -->
    <div id="start-screen" class="start-screen">
      <h2>How to play</h2>
      <p>
        Tap the scrambled letter tiles in the correct order to form a word.
        Tap a placed letter to return it to the rack.
        Words grow longer and rarer as your level rises.
      </p>
      <button class="btn btn-filled" onclick="startGame()">Begin</button>
    </div>

    <!-- Game area -->
    <div id="game-area" class="hidden">

      <div class="timer-row">
        <span class="stat-label">Time</span>
        <span class="timer-value" id="timer-value">30</span>
        <span class="stat-label">sec</span>
      </div>

      <div class="category-label">
        <span class="pill" id="category-pill">—</span>
      </div>

      <!-- Answer row (placed tiles) -->
      <div class="answer-tiles" id="answer-tiles"></div>

      <!-- Scrambled rack -->
      <div class="letter-tiles" id="letter-tiles"></div>

      <div class="feedback" id="feedback"></div>

      <div class="controls-row">
        <button class="btn btn-dark" onclick="clearAnswer()">Clear</button>
        <button class="btn btn-accent" onclick="checkAnswer()" id="submit-btn">Check →</button>
        <button class="btn btn-dark" onclick="skipWord()" id="skip-btn">Skip</button>
      </div>
    </div>

  </main>

  <!-- Game-over modal -->
  <div class="overlay hidden" id="gameover-overlay">
    <div class="modal">
      <h2>Game Over</h2>
      <div class="modal-score" id="final-score">0</div>
      <div class="modal-sub" id="final-sub">Reached level 1</div>
      <div class="name-input-row">
        <input type="text" id="player-name" placeholder="Your name" maxlength="20" />
        <button class="btn btn-accent" onclick="saveScore()">Save</button>
      </div>
      <div class="modal-actions">
        <button class="btn btn-dark" onclick="restartGame()">Play again</button>
        <a href="../index.html" class="btn btn-dark">Home</a>
      </div>
    </div>
  </div>

  <script src="../js/storage.js"></script>
  <script>
  /* ================================================================
     Anagram Game Logic
     ================================================================ */

  /* ── Word bank (grouped by length then difficulty) ─────────────
     Each entry: [word, category]
  */
  const WORDS = {
    4: [
      ['calm','nature'],['lake','nature'],['pine','nature'],['mist','nature'],
      ['dawn','nature'],['dusk','nature'],['leaf','nature'],['fern','nature'],
      ['reed','nature'],['bark','nature'],['lark','nature'],['tide','nature'],
      ['clay','earth'],['sand','earth'],['coal','earth'],['iron','earth'],
      ['foam','water'],['wave','water'],['arch','form'],['echo','sound'],
      ['silk','textile'],['jade','gem'],['gold','gem'],['salt','mineral'],
      ['fire','element'],['flux','science'],['bold','trait'],['wise','trait'],
      ['kind','trait'],['pure','trait'],['slow','motion'],['gust','weather'],
      ['haze','weather'],['rain','weather'],['snow','weather'],['gale','weather'],
      ['pond','water'],['ford','water'],['cove','water'],['rill','water'],
      ['knot','craft'],['loom','craft'],['kite','craft'],['opal','gem'],
    ],
    5: [
      ['still','nature'],['grove','nature'],['bloom','nature'],['cedar','nature'],
      ['birch','nature'],['maple','nature'],['ember','nature'],['cliff','nature'],
      ['ocean','water'],['fjord','water'],['creek','water'],['stone','earth'],
      ['flint','earth'],['chalk','earth'],['shale','earth'],['grain','earth'],
      ['linen','textile'],['ivory','material'],['amber','material'],['pearl','gem'],
      ['light','element'],['flame','element'],['smoke','element'],['frost','weather'],
      ['storm','weather'],['cloud','weather'],['solar','science'],['lunar','science'],
      ['blend','cooking'],['crane','animal'],['swift','animal'],['otter','animal'],
      ['heron','animal'],['finch','animal'],['raven','animal'],['robin','animal'],
      ['lilac','plant'],['thyme','plant'],['cacao','plant'],['olive','plant'],
      ['depth','space'],['ridge','form'],['plain','form'],['trace','form'],
      ['valor','trait'],['grace','trait'],['noble','trait'],['quiet','trait'],
    ],
    6: [
      ['marble','material'],['pebble','earth'],['fossil','earth'],['quartz','mineral'],
      ['copper','mineral'],['silver','mineral'],['cobalt','mineral'],['indigo','colour'],
      ['violet','colour'],['sienna','colour'],['umber','colour'],['forest','nature'],
      ['meadow','nature'],['willow','nature'],['cherry','nature'],['spruce','nature'],
      ['candle','light'],['lantern','light'],['breeze','weather'],['squall','weather'],
      ['serene','trait'],['gentle','trait'],['simple','trait'],['tender','trait'],
      ['autumn','season'],['winter','season'],['season','time'],['solace','feeling'],
      ['refuge','place'],['hollow','place'],['cavern','place'],['grotto','place'],
      ['acacia','plant'],['bamboo','plant'],['clover','plant'],['nettle','plant'],
      ['falcon','animal'],['salmon','animal'],['badger','animal'],['weasel','animal'],
      ['walnut','plant'],['saffron','spice'],['fennel','spice'],['ginger','spice'],
    ],
    7: [
      ['crystal','mineral'],['mineral','earth'],['natural','trait'],['harmony','music'],
      ['clarity','trait'],['balance','form'],['silence','sound'],['pattern','form'],
      ['granite','rock'],['basalt','rock'],['jasmine','plant'],['heather','plant'],
      ['peacock','animal'],['panther','animal'],['sparrow','animal'],['swallow','animal'],
      ['tempest','weather'],['equinox','season'],['solstice','season'],['morning','time'],
      ['twilight','time'],['lantern','light'],['compass','tool'],['pottery','craft'],
      ['weaving','craft'],['mosaic','art'],['fresco','art'],['carving','art'],
      ['ancient','time'],['endure','trait'],['patient','trait'],['resolve','trait'],
    ],
    8: [
      ['serenity','feeling'],['patience','trait'],['solitary','state'],['timeless','time'],
      ['stillness','state'],['tranquil','state'],['ethereal','quality'],['delicate','quality'],
      ['porcelain','material'],['obsidian','mineral'],['dolomite','mineral'],['amethyst','gem'],
      ['sapphire','gem'],['mahogany','wood'],['sycamore','tree'],['magnolia','plant'],
      ['lavender','plant'],['rosewood','wood'],['teakwood','wood'],['driftwood','nature'],
      ['twilight','time'],['moonrise','nature'],['daybreak','nature'],['midwinter','season'],
    ],
  };

  // ── State ──────────────────────────────────────────────────────
  let score    = 0;
  let level    = 1;
  let lives    = 3;
  let streak   = 0;
  let skips    = 3;
  let timeLeft = 30;
  let timerInterval = null;
  let placedLetters  = [];    // { letter, origIdx }
  let scrambled      = [];    // ordered scramble array
  let currentWord    = '';
  let currentCat     = '';
  const STREAK_TO_LEVEL = 3;

  // ── Level config ───────────────────────────────────────────────
  function getWordLength(lvl) {
    if (lvl <= 3)  return 4;
    if (lvl <= 6)  return 5;
    if (lvl <= 10) return 6;
    if (lvl <= 15) return 7;
    return 8;
  }

  function getTimeLimit(lvl) {
    return Math.max(45 - lvl * 2, 15);
  }

  // ── Pick a word ────────────────────────────────────────────────
  function pickWord(lvl) {
    const len = getWordLength(lvl);
    const pool = WORDS[len] || WORDS[4];
    const [word, cat] = pool[Math.floor(Math.random() * pool.length)];
    return { word: word.toUpperCase(), cat };
  }

  function scrambleWord(word) {
    const letters = word.split('');
    // Ensure scramble differs from original
    let attempts = 0;
    do {
      shuffle(letters);
      attempts++;
    } while (letters.join('') === word && attempts < 20);
    return letters;
  }

  // ── UI helpers ─────────────────────────────────────────────────
  function updateScoreDisplay() {
    document.getElementById('score-display').textContent = score.toLocaleString();
    document.getElementById('level-display').textContent = level;
    document.getElementById('progress-fill').style.width =
      (streak / STREAK_TO_LEVEL * 100) + '%';
  }

  function setFeedback(msg, cls) {
    const el = document.getElementById('feedback');
    el.textContent = msg;
    el.className = 'feedback ' + (cls || '');
  }

  function updateTimer() {
    const el = document.getElementById('timer-value');
    el.textContent = timeLeft;
    el.className = 'timer-value' + (timeLeft <= 8 ? ' urgent' : '');
  }

  // ── Render tiles ───────────────────────────────────────────────
  function renderRack() {
    const rack = document.getElementById('letter-tiles');
    rack.innerHTML = '';
    scrambled.forEach((letter, i) => {
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.textContent = letter;
      tile.dataset.idx = i;
      // Mark as used if this index is already placed
      if (placedLetters.some(p => p.origIdx === i)) {
        tile.classList.add('used');
      }
      tile.addEventListener('click', () => placeLetter(i, letter));
      rack.appendChild(tile);
    });
  }

  function renderAnswer() {
    const container = document.getElementById('answer-tiles');
    container.innerHTML = '';
    // Always show target-length slots
    for (let i = 0; i < currentWord.length; i++) {
      const slot = document.createElement('div');
      slot.className = 'answer-slot';
      if (placedLetters[i]) {
        slot.textContent = placedLetters[i].letter;
        slot.dataset.pos = i;
        slot.addEventListener('click', () => returnLetter(i));
      }
      container.appendChild(slot);
    }
  }

  function placeLetter(origIdx, letter) {
    if (placedLetters.some(p => p.origIdx === origIdx)) return;
    if (placedLetters.length >= currentWord.length) return;
    placedLetters.push({ letter, origIdx });
    renderRack();
    renderAnswer();

    // Auto-check when all slots filled
    if (placedLetters.length === currentWord.length) {
      setTimeout(checkAnswer, 300);
    }
  }

  function returnLetter(pos) {
    if (pos < 0 || pos >= placedLetters.length) return;
    placedLetters.splice(pos, 1);
    renderRack();
    renderAnswer();
  }

  function clearAnswer() {
    placedLetters = [];
    renderRack();
    renderAnswer();
  }

  // ── Game flow ──────────────────────────────────────────────────
  function startGame() {
    score = 0; level = 1; lives = 3; streak = 0; skips = 3;
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-area').classList.remove('hidden');
    updateScoreDisplay();
    nextPuzzle();
  }

  function nextPuzzle() {
    clearInterval(timerInterval);
    placedLetters = [];
    setFeedback('');

    const { word, cat } = pickWord(level);
    currentWord = word;
    currentCat  = cat;
    scrambled   = scrambleWord(word);

    document.getElementById('category-pill').textContent = cat;
    document.getElementById('skip-btn').textContent = `Skip (${skips})`;
    document.getElementById('submit-btn').disabled = false;

    renderRack();
    renderAnswer();
    updateScoreDisplay();

    // Timer
    timeLeft = getTimeLimit(level);
    updateTimer();
    timerInterval = setInterval(() => {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        onTimeout();
      }
    }, 1000);
  }

  function onTimeout() {
    lives--;
    streak = Math.max(0, streak - 1);
    setFeedback(`Time's up — the word was ${currentWord}`, 'wrong');
    if (lives <= 0) {
      setTimeout(showGameOver, 1000);
    } else {
      setFeedback(`Time's up · ${lives} mistake${lives!==1?'s':''} left`, 'wrong');
      setTimeout(nextPuzzle, 1400);
    }
  }

  function checkAnswer() {
    if (placedLetters.length < currentWord.length) {
      setFeedback('Fill all tiles first', '');
      return;
    }
    clearInterval(timerInterval);

    const guess = placedLetters.map(p => p.letter).join('');
    const slots = document.querySelectorAll('.answer-slot');

    if (guess === currentWord) {
      slots.forEach(s => s.classList.add('correct-anim'));
      const timeBonus = Math.max(0, timeLeft * 3);
      const points = Math.round((100 * level + timeBonus) * (1 + streak * 0.1));
      score += points;
      streak++;
      setFeedback(`+${points}  Correct!`, 'correct');
      if (streak >= STREAK_TO_LEVEL) { level++; streak = 0; }
      updateScoreDisplay();
      setTimeout(nextPuzzle, 1000);
    } else {
      slots.forEach(s => s.classList.add('wrong-anim'));
      lives--;
      streak = Math.max(0, streak - 1);
      setTimeout(() => {
        slots.forEach(s => s.classList.remove('wrong-anim'));
        if (lives <= 0) {
          showGameOver();
        } else {
          setFeedback(`Not quite · the word was ${currentWord}`, 'wrong');
          setTimeout(nextPuzzle, 1000);
        }
      }, 600);
    }
  }

  function skipWord() {
    if (skips <= 0) {
      setFeedback('No skips remaining', '');
      return;
    }
    skips--;
    clearInterval(timerInterval);
    streak = Math.max(0, streak - 1);
    setFeedback(`Skipped — the word was ${currentWord}`, '');
    setTimeout(nextPuzzle, 900);
  }

  // ── Game over ──────────────────────────────────────────────────
  function showGameOver() {
    clearInterval(timerInterval);
    document.getElementById('final-score').textContent = score.toLocaleString();
    document.getElementById('final-sub').textContent = `Reached level ${level}`;
    document.getElementById('gameover-overlay').classList.remove('hidden');
    document.getElementById('player-name').focus();
  }

  function saveScore() {
    const name = document.getElementById('player-name').value.trim() || 'Anonymous';
    Storage.addScore('anagram', { name, score, level });
    document.getElementById('player-name').disabled = true;
    document.querySelector('#gameover-overlay .btn-accent').disabled = true;
  }

  function restartGame() {
    clearInterval(timerInterval);
    document.getElementById('gameover-overlay').classList.add('hidden');
    startGame();
  }

  // ── Utility ────────────────────────────────────────────────────
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  </script>
</body>
</html>
